import logging                           import asyncio                           import re                                import json                              import os                                import fasttext                          from pathlib import Path                 from datetime import datetime, timedelta from typing import Dict, List            from aiogram import Bot, Dispatcher, F, Router                                    from aiogram.filters import Command, ChatMemberUpdatedFilter, IS_NOT_MEMBER, IS_MEMBER                                     from aiogram.types import Message, ChatPermissions, ChatMemberUpdated, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery                                    from aiogram.types import InlineQuery, InlineQueryResultArticle, InputTextMessageContent, InlineQueryResultCachedSticker   from aiogram.exceptions import TelegramAPIError                                   from dotenv import load_dotenv                                                    # .env —Ñ–∞–π–ª—ã–Ω –∂“Ø–∫—Ç–µ—É                     load_dotenv()                                                                     # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ                            LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')                                        logging.basicConfig(                         format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',                    level=getattr(logging, LOG_LEVEL)    )                                        logger = logging.getLogger(__name__)                                              # FastText –ª–æ–≥—Ç–∞—Ä—ã–Ω ”©—à—ñ—Ä—É                fasttext.FastText.eprint = lambda x: None                                         # –ë–æ—Ç —Ç–æ–∫–µ–Ω—ñ (”©–∑—ñ“£—ñ–∑–¥—ñ“£ —Ç–æ–∫–µ–Ω—ñ“£—ñ–∑–¥—ñ .env-–≥–µ “õ–æ–π—ã“£—ã–∑)                              BOT_TOKEN = os.getenv('BOT_TOKEN')       if not BOT_TOKEN:                            raise ValueError("BOT_TOKEN .env —Ñ–∞–π–ª—ã–Ω–¥–∞ –∂–æ“õ!")                                                                       # ”ò–∫—ñ–º—à—ñ ID (”©–∑—ñ“£—ñ–∑–¥—ñ“£ ID-“£—ñ–∑–¥—ñ .env-–≥–µ “õ–æ–π—ã“£—ã–∑)                                  ADMIN_ID = int(os.getenv('ADMIN_ID', 0)) if ADMIN_ID == 0:                            logger.warning("ADMIN_ID –æ—Ä–Ω–∞—Ç—ã–ª–º–∞“ì–∞–Ω!")                                                                               # –§–∞–π–ª –∂–æ–ª–¥–∞—Ä—ã                           FASTTEXT_MODEL_PATH = os.getenv('FASTTEXT_MODEL_PATH', 'lid.176.bin')             DICTIONARY_FILE = os.getenv('DICTIONARY_FILE', 'dictionary.json')                                                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è                           WARNING_LIMIT = int(os.getenv('WARNING_LIMIT', 4))                                INLINE_CACHE_TIME = int(os.getenv('INLINE_CACHE_TIME', 10))                                                                # Router –∂–∞—Å–∞—É                           router = Router()                                                                                                          class KazakhLanguageBot:                     def __init__(self):                          # “ö–æ–ª–¥–∞–Ω—É—à—ã–ª–∞—Ä —Ç—É—Ä–∞–ª—ã –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä         self.user_warnings: Dict[int, Dict] = {}                                          self.user_mistakes: Dict[int, List[Dict]] = {}                                                                             # –ñ–∞“£–∞ –º“Ø—à–µ–ª–µ—Ä —Ç—ñ–ª—ñ–Ω —Ç–µ–∫—Å–µ—Ä—É             self.pending_users: Dict[int, Dict] = {}                                                                                   # –§–∞–π–ª –∞—Ç—Ç–∞—Ä—ã                            self.words_file = "dictionary.json"                                               self.data_file = "bot_data.json"                                                  # FastText –º–æ–¥–µ–ª—ñ–Ω –∂“Ø–∫—Ç–µ—É                self.load_fasttext_model()                                                        # –°”©–∑–¥—ñ–∫—Ç—ñ –∂“Ø–∫—Ç–µ—É –Ω–µ–º–µ—Å–µ –±–∞—Å—Ç–∞–ø“õ—ã —Å”©–∑–¥—ñ–∫ “õ“±—Ä—É                                     self.load_dictionary()                                                            # –ê—Ä–∞–ª–∞—Å—Ç—ã—Ä—É “Ø–ª–≥—ñ–ª–µ—Ä—ñ                    self.mixed_patterns = [                      r'–µ—Å–ª–∏\s*[-\s]*—á–æ',                      r'–Ω–∞–¥–æ–µ–ª\s+–±–æ–ª–¥—ã“£',                      r'—á–æ\s*—Ç–∞–º\s+–±–∞',                        r'–Ω—É\s+\w+“£—ã–∑',                          r'–≤–æ—Ç\s+\w+–º—ã–Ω',                     ]                                                                             def load_fasttext_model(self):               """FastText –º–æ–¥–µ–ª—ñ–Ω –∂“Ø–∫—Ç–µ–π–¥—ñ"""          model_path = "lid.176.bin"                                                        if not os.path.exists(model_path):                                                    logger.warning(f"FastText –º–æ–¥–µ–ª—å —Ç–∞–±—ã–ª–º–∞–¥—ã: {model_path}")                        logger.info("–ú–æ–¥–µ–ª–¥—ñ –∂“Ø–∫—Ç–µ—É: wget https://dl.fbaipublicfiles.com/fasttext/supervised-models/lid.176.bin")                  self.lang_model = None               else:                                        try:                                         self.lang_model = fasttext.load_model(model_path)                                 logger.info("FastText –º–æ–¥–µ–ª—å –∂“Ø–∫—Ç–µ–ª–¥—ñ")                                       except Exception as e:                       logger.error(f"FastText –º–æ–¥–µ–ª—ñ–Ω –∂“Ø–∫—Ç–µ—É–¥–µ “õ–∞—Ç–µ: {e}")                              self.lang_model = None                                                def detect_language(self, text: str) -> tuple:                                        """–ú”ô—Ç—ñ–Ω —Ç—ñ–ª—ñ–Ω –∞–Ω—ã“õ—Ç–∞–π–¥—ã (—Ç—ñ–ª –∫–æ–¥—ã, —ã“õ—Ç–∏–º–∞–ª–¥—ã“õ)"""                                if not self.lang_model:                      return None, 0.0                                                              try:                                         # –ú”ô—Ç—ñ–Ω–¥—ñ —Ç–∞–∑–∞–ª–∞—É                        text = text.replace('\n', ' ').strip()                                            if len(text) < 3:                            return None, 0.0                                                              # NumPy –µ—Å–∫–µ—Ä—Ç—É–ª–µ—Ä—ñ–Ω ”©—à—ñ—Ä—É               import warnings                          with warnings.catch_warnings():                                                       warnings.filterwarnings('ignore')                                                 # –¢—ñ–ª–¥—ñ –∞–Ω—ã“õ—Ç–∞—É                          predictions = self.lang_model.predict(text, k=1)                                                                       language = predictions[0][0].replace('__label__', '')                             confidence = predictions[1][0]                                                                                             return language, confidence          except Exception as e:                       # –ï–≥–µ—Ä FastText –∂“±–º—ã—Å —ñ—Å—Ç–µ–º–µ—Å–µ, —Å”©–∑–¥—ñ–∫ –∞—Ä“õ—ã–ª—ã —Ç–µ–∫—Å–µ—Ä–µ–º—ñ–∑                          logger.debug(f"FastText “õ–∞—Ç–µ—Å—ñ: {str(e)[:100]}")                                  return None, 0.0                                                              # –ê—Ä–∞–ª–∞—Å—Ç—ã—Ä—É “Ø–ª–≥—ñ–ª–µ—Ä—ñ                    self.mixed_patterns = [                      r'–µ—Å–ª–∏\s*[-\s]*—á–æ',                      r'–Ω–∞–¥–æ–µ–ª\s+–±–æ–ª–¥—ã“£',                      r'—á–æ\s*—Ç–∞–º\s+–±–∞',                        r'–Ω—É\s+\w+“£—ã–∑',                          r'–≤–æ—Ç\s+\w+–º—ã–Ω',                     ]                                                                             def load_dictionary(self):                   """–°”©–∑–¥—ñ–∫—Ç—ñ —Ñ–∞–π–ª–¥–∞–Ω –∂“Ø–∫—Ç–µ–π–¥—ñ"""          if os.path.exists(self.words_file):                                                   try:                                         with open(self.words_file, 'r', encoding='utf-8') as f:                               data = json.load(f)                      self.wrong_words = data.get('wrong_words', {})                                    self.russian_words = set(data.get('russian_words', []))                       logger.info(f"–°”©–∑–¥—ñ–∫ –∂“Ø–∫—Ç–µ–ª–¥—ñ: {len(self.wrong_words)} –±“±—Ä—ã—Å —Å”©–∑, {len(self.russian_words)} –æ—Ä—ã—Å—à–∞ —Å”©–∑")               except Exception as e:                       logger.error(f"–°”©–∑–¥—ñ–∫—Ç—ñ –∂“Ø–∫—Ç–µ—É–¥–µ “õ–∞—Ç–µ: {e}")                                      self.create_default_dictionary()                                          else:                                        self.create_default_dictionary()                                                                                   def create_default_dictionary(self):         """–ë–∞—Å—Ç–∞–ø“õ—ã —Å”©–∑–¥—ñ–∫ “õ“±—Ä–∞–¥—ã"""             self.wrong_words = {                         '–±—É–≥—ã–Ω': '–±“Ø–≥—ñ–Ω',                        '—è': '–º–µ–Ω',                              '–∏–∞': '–∏”ô',                              '—Å–µ–Ω—ã–Ω': '—Å–µ–Ω—ñ“£',                        '–º–µ–Ω—ã–Ω': '–º–µ–Ω—ñ“£',                        '–º–µ–Ω—ñ–Ω': '–º–µ–Ω—ñ“£',                        '–±“±—Ä—ã“£“ì—ã': '–±“±—Ä—ã–Ω“ì—ã',                    '“õ–∞–∑–∞–∫': '“õ–∞–∑–∞“õ',                        '–∫–∞–∑–∞—Ö': '“õ–∞–∑–∞“õ',                        '–∫–∞–∑–∞–∫—Å—Ç–∞–Ω': '“ö–∞–∑–∞“õ—Å—Ç–∞–Ω',                '—Ä–∞—Ö–º–µ—Ç': '—Ä–∞“õ–º–µ—Ç',                      '—Å–∏–∑–¥—ã': '—Å—ñ–∑–¥—ñ',                        '–±—ñ–∑–¥—ã': '–±—ñ–∑–¥—ñ',                        '–æ–ª–æ—Ä–¥—ã': '–æ–ª–∞—Ä–¥—ã',                      '—Å—ñ–∑–≥–µ': '—Å—ñ–∑–≥–µ',                        '–±–æ–ª–º–∞–π': '–±–æ–ª–º–∞–π',                      '–∂–∞“õ—Å—ã': '–∂–∞“õ—Å—ã',                        '–∂–∞–∫—Å—ã': '–∂–∞“õ—Å—ã',                        '–∫–µ—Ä–µ–∫': '–∫–µ—Ä–µ–∫',                        '–∫–µ—Ä”ô–∫': '–∫–µ—Ä–µ–∫',                        '—Å–∞–ª–∞–º': '—Å”ô–ª–µ–º',                    }                                                                                 self.russian_words = {                       '—É–∂–µ', '—Å–ø–∞—Å–∏–±–æ', '–¥–∞', '–ª–∞–¥–Ω–æ', '–Ω–µ—Ç', '—Ö–æ—Ä–æ—à–æ', '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',                   '–∫–æ–Ω–µ—á–Ω–æ', '–º–æ–∂–Ω–æ', '–Ω–∞–¥–æ', '–µ—Å–ª–∏', '—á—Ç–æ–±—ã', '–ø–æ—Ç–æ–º—É', '–ø–æ—ç—Ç–æ–º—É',                 '—Å–µ–π—á–∞—Å', '–∑–∞–≤—Ç—Ä–∞', '–≤—á–µ—Ä–∞', '—Å–µ–≥–æ–¥–Ω—è', '–≤—Å–µ–≥–¥–∞', '–Ω–∏–∫–æ–≥–¥–∞',                      '–º–Ω–æ–≥–æ', '–º–∞–ª–æ', '–æ—á–µ–Ω—å', '—Ç–æ–∂–µ', '—Ç–∞–∫–∂–µ', '–Ω–∞–¥–æ–µ–ª', '–¥–∞–≤–∞–π',                     '–Ω—É', '–≤–æ—Ç', '—ç—Ç–æ', '—á—Ç–æ', '–∫–∞–∫', '–ø–æ—á–µ–º—É', '–∫–æ–≥–¥–∞', '–≥–¥–µ',                       '—Ö–æ—Ä–æ—à–æ', '–ø–ª–æ—Ö–æ', '–Ω–æ—Ä–º–∞–ª—å–Ω–æ', '–æ–∫', '–æ–∫–µ–π', '–ø–æ–∫–∞', '–ø—Ä–∏–≤–µ—Ç'                }                                                                                 self.save_dictionary()                                                        def save_dictionary(self):                   """–°”©–∑–¥—ñ–∫—Ç—ñ —Ñ–∞–π–ª“ì–∞ —Å–∞“õ—Ç–∞–π–¥—ã"""           try:                                         data = {                                     'wrong_words': self.wrong_words,                                                  'russian_words': list(self.russian_words),                                        'last_updated': datetime.now().isoformat()                                    }                                        with open(self.words_file, 'w', encoding='utf-8') as f:                               json.dump(data, f, ensure_ascii=False, indent=2)                              logger.info("–°”©–∑–¥—ñ–∫ —Å–∞“õ—Ç–∞–ª–¥—ã")                                                except Exception as e:                       logger.error(f"–°”©–∑–¥—ñ–∫—Ç—ñ —Å–∞“õ—Ç–∞—É–¥–∞ “õ–∞—Ç–µ: {e}")                                                                       def is_language_kazakh(self, language_code: str) -> bool:                             """“ö–æ–ª–¥–∞–Ω—É—à—ã —Ç—ñ–ª—ñ “õ–∞–∑–∞“õ—à–∞ –µ–∫–µ–Ω—ñ–Ω —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ"""                                     return language_code and language_code.lower() in ['kk', 'kk-kz', 'kaz']                                               def add_pending_user(self, user_id: int, chat_id: int):                               """–ö“Ø—Ç—ñ–ª–µ—Ç—ñ–Ω “õ–æ–ª–¥–∞–Ω—É—à—ã–ª–∞—Ä“ì–∞ “õ–æ—Å–∞–¥—ã"""                                             self.pending_users[user_id] = {              'chat_id': chat_id,                      'join_time': datetime.now(),             'warned_times': []                   }                                                                             def remove_pending_user(self, user_id: int):                                          """–ö“Ø—Ç—ñ–ª–µ—Ç—ñ–Ω “õ–æ–ª–¥–∞–Ω—É—à—ã–ª–∞—Ä–¥–∞–Ω –∞–ª—ã–ø —Ç–∞—Å—Ç–∞–π–¥—ã"""                                     if user_id in self.pending_users:            del self.pending_users[user_id]                                                                                    def check_russian_words(self, text: str) -> List[str]:                                """–û—Ä—ã—Å—à–∞ —Å”©–∑–¥–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ"""          text_lower = text.lower()                found_russian = []                                                                for rus_word in self.russian_words:                                                   if re.search(r'\b' + rus_word + r'\b', text_lower):                                   found_russian.append(rus_word)                                                                                     return found_russian                                                          def is_text_kazakh(self, text: str) -> tuple:                                         """–ú”ô—Ç—ñ–Ω–Ω—ñ“£ “õ–∞–∑–∞“õ—à–∞ –µ–∫–µ–Ω—ñ–Ω FastText –∞—Ä“õ—ã–ª—ã —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ"""                           language, confidence = self.detect_language(text)                                                                          if language == 'kk':  # “ö–∞–∑–∞“õ —Ç—ñ–ª—ñ                                                    return True, confidence              elif language == 'ru':  # –û—Ä—ã—Å —Ç—ñ–ª—ñ                                                   return False, confidence             else:                                        # –ï–≥–µ—Ä FastText –∞–Ω—ã“õ—Ç–∞–º–∞—Å–∞, —Å”©–∑–¥—ñ–∫ –∞—Ä“õ—ã–ª—ã —Ç–µ–∫—Å–µ—Ä–µ–º—ñ–∑                              russian_words = self.check_russian_words(text)                                    if russian_words:                            return False, 0.5                    return True, 0.3  # –ë–µ–ª–≥—ñ—Å—ñ–∑, –±—ñ—Ä–∞“õ –æ—Ä—ã—Å—à–∞ –µ–º–µ—Å                                                                    def check_wrong_words(self, text: str) -> List[Dict[str, str]]:                       """–ë“±—Ä—ã—Å –∂–∞–∑—ã–ª“ì–∞–Ω —Å”©–∑–¥–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ"""                                           text_lower = text.lower()                mistakes = []                                                                     for wrong, correct in self.wrong_words.items():                                       if re.search(r'\b' + wrong + r'\b', text_lower):                                      mistakes.append({'wrong': wrong, 'correct': correct})                                                              return mistakes                                                               def check_mixed_language(self, text: str) -> List[str]:                               """–ê—Ä–∞–ª–∞—Å—Ç—ã—Ä—ã–ø –∂–∞–∑—É–¥—ã —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ"""                                                text_lower = text.lower()                mixed_found = []                                                                  for pattern in self.mixed_patterns:                                                   if re.search(pattern, text_lower):                                                    mixed_found.append(pattern)                                                                                        # –ñ–∞–ª–ø—ã –∞—Ä–∞–ª–∞—Å—Ç—ã—Ä—É: “õ–∞–∑–∞“õ—à–∞ —Å”©–π–ª–µ–º —ñ—à—ñ–Ω–¥–µ –æ—Ä—ã—Å—à–∞ —Å”©–∑                              words = text_lower.split()               if len(words) > 3:                           rus_count = sum(1 for word in words if word in self.russian_words)                kazakh_chars = re.findall(r'[”ô—ñ“£“ì“Ø“±“õ”©“ª”ò–Ü“¢“í“Æ“∞“ö”®“∫]', text)                          if rus_count > 0 and len(kazakh_chars) > 0:                                           mixed_found.append("mixed_sentence")                                                                               return mixed_found                                                            def add_warning(self, user_id: int, chat_id: int, reason: str = None) -> int:         """–ï—Å–∫–µ—Ä—Ç—É “õ–æ—Å–∞–¥—ã –∂”ô–Ω–µ —Å–∞–Ω—ã–Ω “õ–∞–π—Ç–∞—Ä–∞–¥—ã"""                                         if user_id not in self.user_warnings:                                                 self.user_warnings[user_id] = {}                                                                                       if chat_id not in self.user_warnings[user_id]:                                        self.user_warnings[user_id][chat_id] = {'count': 0, 'reasons': []}                                                     self.user_warnings[user_id][chat_id]['count'] += 1                                                                         if reason:                                   self.user_warnings[user_id][chat_id]['reasons'].append({                              'reason': reason,                        'time': datetime.now()               })                                                                            return self.user_warnings[user_id][chat_id]['count']                                                                   def get_warnings(self, user_id: int, chat_id: int) -> int:                            """–ï—Å–∫–µ—Ä—Ç—É —Å–∞–Ω—ã–Ω “õ–∞–π—Ç–∞—Ä–∞–¥—ã"""            if user_id in self.user_warnings and chat_id in self.user_warnings[user_id]:                                                   return self.user_warnings[user_id][chat_id]['count']                          return 0                                                                      def get_warning_reasons(self, user_id: int, chat_id: int) -> List[Dict]:              """–ï—Å–∫–µ—Ä—Ç—É —Å–µ–±–µ–ø—Ç–µ—Ä—ñ–Ω “õ–∞–π—Ç–∞—Ä–∞–¥—ã"""                                                if user_id in self.user_warnings and chat_id in self.user_warnings[user_id]:                                                   return self.user_warnings[user_id][chat_id].get('reasons', [])                return []                                                                     def add_mistake(self, user_id: int, mistakes: List[Dict[str, str]]):                  """“ö–∞—Ç–µ–ª–µ—Ä–¥—ñ –∂–∏–Ω–∞–π–¥—ã"""                  if user_id not in self.user_mistakes:                                                 self.user_mistakes[user_id] = []                                                                                       self.user_mistakes[user_id].extend(mistakes)                                                                           def reset_user_data(self, user_id: int, chat_id: int):                                """“ö–æ–ª–¥–∞–Ω—É—à—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ–Ω —Ç–∞—Å—Ç–∞–π–¥—ã"""                                               if user_id in self.user_warnings and chat_id in self.user_warnings[user_id]:                                                   del self.user_warnings[user_id][chat_id]                                                                               if user_id in self.user_mistakes:            del self.user_mistakes[user_id]                                                                                    async def apply_punishment(self, bot: Bot, message: Message, warning_count: int) -> str:                                       """–ñ–∞–∑–∞–ª–∞—É —Ç”ô—Ä—Ç—ñ–±—ñ–Ω “õ–æ–ª–¥–∞–Ω–∞–¥—ã"""         chat_id = message.chat.id                user_id = message.from_user.id                                                    try:                                         if warning_count == 5:                       # 5 –º–∏–Ω—É—Ç “Ø–Ω—ñ–Ω ”©—à—ñ—Ä—É                     until_date = datetime.now() + timedelta(minutes=5)                                await bot.restrict_chat_member(                                                       chat_id=chat_id,                         user_id=user_id,                         permissions=ChatPermissions(can_send_messages=False),                             until_date=until_date                )                                        return "üîá 5 –º–∏–Ω—É—Ç“õ–∞ “Ø–Ω—ñ“£—ñ–∑ ”©—à—ñ—Ä—ñ–ª–¥—ñ"                                                                                  elif warning_count == 6:                     # 30 –º–∏–Ω—É—Ç “Ø–Ω—ñ–Ω ”©—à—ñ—Ä—É                    until_date = datetime.now() + timedelta(minutes=30)                               await bot.restrict_chat_member(                                                       chat_id=chat_id,                         user_id=user_id,                         permissions=ChatPermissions(can_send_messages=False),                             until_date=until_date                )                                        return "üîá 30 –º–∏–Ω—É—Ç“õ–∞ “Ø–Ω—ñ“£—ñ–∑ ”©—à—ñ—Ä—ñ–ª–¥—ñ"                                                                                 elif warning_count == 7:                     # –ë—ñ—Ä –∫“Ø–Ω “Ø–Ω—ñ–Ω ”©—à—ñ—Ä—É                     until_date = datetime.now() + timedelta(days=1)                                   await bot.restrict_chat_member(                                                       chat_id=chat_id,                         user_id=user_id,                         permissions=ChatPermissions(can_send_messages=False),                             until_date=until_date                )                                        return "üîá 1 –∫“Ø–Ω–≥–µ “Ø–Ω—ñ“£—ñ–∑ ”©—à—ñ—Ä—ñ–ª–¥—ñ"                                                                                    elif warning_count == 8:                     # –¢–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—É                          await bot.unban_chat_member(chat_id=chat_id, user_id=user_id, only_if_banned=False)                                        return "üö´ –¢–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—ã–ª–¥—ã“£—ã–∑"                                                                                        elif warning_count >= 9:                     # –ë“±“ì–∞—Ç—Ç–∞—É                               await bot.ban_chat_member(chat_id=chat_id, user_id=user_id)                       return "‚õî –¢–æ–ø—Ç–∞ –±“±“ì–∞—Ç—Ç–∞–ª–¥—ã“£—ã–∑"                                                                                    except TelegramAPIError as e:                logger.error(f"–ñ–∞–∑–∞ “õ–æ–ª–¥–∞–Ω—É–¥–∞ “õ–∞—Ç–µ: {e}")                                         return "‚ùå –ñ–∞–∑–∞ “õ–æ–ª–¥–∞–Ω—É–¥–∞ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã (–±–æ—Ç“õ–∞ –∞–¥–º–∏–Ω “õ“±“õ—ã“ì—ã–Ω –±–µ—Ä—ñ“£—ñ–∑)"                                                                                         return ""                                                                     async def send_mistakes_to_user(self, bot: Bot, user_id: int, reason: str):           """“ö–æ–ª–¥–∞–Ω—É—à—ã“ì–∞ “õ–∞—Ç–µ–ª–µ—Ä–¥—ñ –∂—ñ–±–µ—Ä–µ–¥—ñ"""                                              if user_id not in self.user_mistakes or not self.user_mistakes[user_id]:              return                                                                        # “ö–∞–π—Ç–∞–ª–∞–Ω–±–∞–π—Ç—ã–Ω “õ–∞—Ç–µ–ª–µ—Ä–¥—ñ –∂–∏–Ω–∞—É         unique_mistakes = {}                     for mistake in self.user_mistakes[user_id]:                                           wrong = mistake['wrong']                 if wrong not in unique_mistakes:                                                      unique_mistakes[wrong] = mistake['correct']                                                                        message = f"üìö <b>–°—ñ–∑–¥—ñ“£ –∂–∏—ñ –∫–µ–∑–¥–µ—Å–µ—Ç—ñ–Ω “õ–∞—Ç–µ–ª–µ—Ä—ñ“£—ñ–∑:</b>\n\n"                     message += f"<i>{reason}</i>\n\n"                                                 for wrong, correct in unique_mistakes.items():                                        message += f"‚ùå {wrong} ‚û°Ô∏è ‚úÖ {correct}\n"                                                                              message += "\nüí° –û—Å—ã “õ–∞—Ç–µ–ª–µ—Ä–¥—ñ —Ç“Ø–∑–µ—Ç—ñ–ø, “õ–∞–∑–∞“õ—à–∞ —Å–∞—É–∞—Ç—Ç—ã –∂–∞–∑—É“ì–∞ —Ç—ã—Ä—ã—Å—ã“£—ã–∑!"        message += "\n\nüîÑ –¢–æ–ø“õ–∞ “õ–∞–π—Ç–∞ –æ—Ä–∞–ª—É “Ø—à—ñ–Ω /test –∫–æ–º–∞–Ω–¥–∞—Å—ã–Ω “õ–æ–ª–¥–∞–Ω—ã“£—ã–∑"                                                     try:                                         await bot.send_message(                      chat_id=user_id,                         text=message,                            parse_mode='HTML'                    )                                    except TelegramAPIError as e:                if "blocked" in str(e).lower():                                                       logger.warning(f"“ö–æ–ª–¥–∞–Ω—É—à—ã –±–æ—Ç—Ç—ã –±“±“ì–∞—Ç—Ç–∞“ì–∞–Ω: {user_id}")                      else:                                        logger.error(f"–ñ–µ–∫–µ —Ö–∞—Ç –∂—ñ–±–µ—Ä—É–¥–µ “õ–∞—Ç–µ: {e}")                                                                                                        # –ë–æ—Ç –æ–±—ä–µ–∫—Ç—ñ—Å—ñ                          bot_instance = KazakhLanguageBot()                                                                                         @router.message(Command("start"))        async def cmd_start(message: Message):       """Start –∫–æ–º–∞–Ω–¥–∞—Å—ã"""                    await message.answer(                        "üëã <b>–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ!</b>\n\n"           "–ú–µ–Ω “õ–∞–∑–∞“õ—à–∞ —Å–∞—É–∞—Ç—Ç—ã –∂–∞–∑—É–¥—ã “õ–∞–¥–∞“ì–∞–ª–∞–π—Ç—ã–Ω –±–æ—Ç–ø—ã–Ω.\n\n"                             "üîπ –û—Ä—ã—Å—à–∞ –∂–∞–∑—Å–∞“£—ã–∑ - –µ—Å–∫–µ—Ä—Ç–µ–º—ñ–Ω\n"                                               "üîπ –ë“±—Ä—ã—Å –∂–∞–∑—Å–∞“£—ã–∑ - —Ç“Ø–∑–µ—Ç–µ–º—ñ–Ω\n"        "üîπ –ê—Ä–∞–ª–∞—Å—Ç—ã—Ä—ã–ø –∂–∞–∑—Å–∞“£—ã–∑ - –µ—Å–∫–µ—Ä—Ç–µ–º—ñ–Ω\n\n"                                        "4 –µ—Å–∫–µ—Ä—Ç—É–¥–µ–Ω –∫–µ–π—ñ–Ω –∂–∞–∑–∞–ª–∞—É –±–∞—Å—Ç–∞–ª–∞–¥—ã.\n\n"                                       "<b>üë§ “ö–æ–ª–¥–∞–Ω—É—à—ã –∫–æ–º–∞–Ω–¥–∞–ª–∞—Ä—ã:</b>\n"                                              "/me - –ú–µ–Ω—ñ“£ –ø—Ä–æ—Ñ–∏–ª—ñ–º\n"                 "/info - “ö–æ–ª–¥–∞–Ω—É—à—ã —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç\n"                                              "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"                  "/mistakes - –ú–µ–Ω—ñ“£ “õ–∞—Ç–µ–ª–µ—Ä—ñ–º\n\n"        "<b>üëë –ú–æ–¥–µ—Ä–∞—Ü–∏—è (–ê–¥–º–∏–Ω):</b>\n"         "/warn - –ï—Å–∫–µ—Ä—Ç—É –±–µ—Ä—É\n"                 "/mute - “Æ–Ω—ñ–Ω ”©—à—ñ—Ä—É\n"                   "/kick - –®—ã“ì–∞—Ä—É\n"                       "/ban - –ë“±“ì–∞—Ç—Ç–∞—É\n\n"                    "<b>üî± ”ò–∫—ñ–º—à—ñ–ª—ñ–∫:</b>\n"                 "/promote - ”ò–∫—ñ–º—à—ñ —Ç–∞“ì–∞–π—ã–Ω–¥–∞—É (1)\n"                                              "<code>.admin</code> - –î–µ“£–≥–µ–π–ª—ñ —Ç–∞“ì–∞–π—ã–Ω–¥–∞—É (1-7)\n"                               "/addwordbl - –¢—ã–π—ã–º —Å”©–∑ “õ–æ—Å—É\n"          "/rules - –ï—Ä–µ–∂–µ–ª–µ—Ä\n"                    "/pin - –•–∞—Ç –±–µ–∫—ñ—Ç—É\n"                    "/translate - –ê—É–¥–∞—Ä–º–∞\n"                 "<code>@admin</code> - –ê–¥–º–∏–Ω–¥–µ—Ä–¥—ñ —à–∞“õ—ã—Ä—É\n\n"                                     "<b>‚öôÔ∏è –ë–∞—Å“õ–∞—Ä—É:</b>\n"                    "/admin - ”ò–∫—ñ–º—à—ñ —Ç–∞“õ—Ç–∞—Å—ã (–±–∞—Å –∞–¥–º–∏–Ω)",                                            parse_mode='HTML'                    )                                                                                                                      @router.message(Command("me"))           async def cmd_me(message: Message):          """“ö–æ–ª–¥–∞–Ω—É—à—ã–Ω—ã“£ ”©–∑ –ø—Ä–æ—Ñ–∏–ª—ñ"""            user_id = message.from_user.id           chat_id = message.chat.id                user_name = message.from_user.full_name                                           username = f"@{message.from_user.username}" if message.from_user.username else "–ñ–æ“õ"                                                                                # –ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä                             warnings = bot_instance.get_warnings(user_id, chat_id)                                                                     # “ö–∞—Ç–µ–ª–µ—Ä                                mistakes_count = len(bot_instance.user_mistakes.get(user_id, []))                 unique_mistakes = len(set(                   m['wrong'] for m in bot_instance.user_mistakes.get(user_id, [])               ))                                                                                # –°—Ç–∞—Ç—É—Å                                 if warnings == 0:                            status = "üü¢ ”®—Ç–µ –∂–∞“õ—Å—ã"                  status_emoji = "üòä"                  elif warnings <= 2:                          status = "üü° –ñ–∞“õ—Å—ã"                      status_emoji = "üòê"                  elif warnings <= 4:                          status = "üü† –ù–∞–∑–∞—Ä –∞—É–¥–∞—Ä—ã“£—ã–∑"            status_emoji = "üò¨"                  else:                                        status = "üî¥ “ö–∞—É—ñ–ø—Ç—ñ –∞–π–º–∞“õ"              status_emoji = "üò∞"                                                           # –î–µ“£–≥–µ–π                                 if warnings == 0 and mistakes_count == 0:                                             level = "üèÜ ”®–Ω–µ–≥–µ"                   elif warnings <= 1:                          level = "‚≠ê “Æ–∑–¥—ñ–∫"                   elif warnings <= 3:                          level = "üìù –ñ–∞“õ—Å—ã –æ“õ—É—à—ã"             else:                                        level = "‚ö†Ô∏è –ù–∞–∑–∞—Ä “õ–∞–∂–µ—Ç"                                                       text = (                                     f"üë§ <b>–ú–µ–Ω—ñ“£ –ø—Ä–æ—Ñ–∏–ª—ñ–º</b> {status_emoji}\n\n"                                    f"<b>–ê—Ç—ã-–∂”©–Ω—ñ:</b> {user_name}\n"        f"<b>Username:</b> {username}\n"         f"<b>ID:</b> <code>{user_id}</code>\n\n"                                          f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"               f"‚ö†Ô∏è –ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä: {warnings}/4\n"          f"‚ùå “ö–∞—Ç–µ–ª–µ—Ä: {mistakes_count} ({unique_mistakes} —Ç“Ø—Ä–ª—ñ)\n"                       f"üìà –°—Ç–∞—Ç—É—Å: {status}\n"                 f"üéØ –î–µ“£–≥–µ–π: {level}\n\n"            )                                                                                 # –°–æ“£“ì—ã “õ–∞—Ç–µ–ª–µ—Ä                          if user_id in bot_instance.user_mistakes and bot_instance.user_mistakes[user_id]:                                              recent_mistakes = {}                     for mistake in bot_instance.user_mistakes[user_id][-5:]:                              wrong = mistake['wrong']                 if wrong not in recent_mistakes:                                                      recent_mistakes[wrong] = mistake['correct']                                                                        text += "üìù <b>–°–æ“£“ì—ã “õ–∞—Ç–µ–ª–µ—Ä:</b>\n"                                              for wrong, correct in recent_mistakes.items():                                        text += f"  ‚Ä¢ {wrong} ‚û°Ô∏è {correct}\n"                                      else:                                        text += "‚úÖ <i>“ö–∞—Ç–µ–ª–µ—Ä –∂–æ“õ! ”®—Ç–µ –∂–∞“õ—Å—ã!</i>"                                                                            await message.answer(text, parse_mode='HTML')                                                                                                                   @router.message(Command("info"))         async def cmd_info(message: Message):        """–ë–∞—Å“õ–∞ “õ–æ–ª–¥–∞–Ω—É—à—ã —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç"""     args = message.text.split(maxsplit=1)    target_user = None                       target_user_id = None                    chat_id = message.chat.id                                                         # 1. Reply –±–æ–ª—É—ã–Ω —Ç–µ–∫—Å–µ—Ä—É                if message.reply_to_message:                 target_user = message.reply_to_message.from_user                                  target_user_id = target_user.id                                               # 2. Username/ID –∞—Ä“õ—ã–ª—ã —ñ–∑–¥–µ—É            elif len(args) > 1:                          identifier = args[1].strip()                                                      # @ –±–µ–ª–≥—ñ—Å—ñ–Ω –∞–ª—ã–ø —Ç–∞—Å—Ç–∞—É                 if identifier.startswith('@'):               identifier = identifier[1:]                                                   # ID –±–æ–ª—É—ã–Ω —Ç–µ–∫—Å–µ—Ä—É                      if identifier.isdigit():                     target_user_id = int(identifier)                                                  try:                                         chat_member = await message.bot.get_chat_member(chat_id, target_user_id)                                                   target_user = chat_member.user                                                except TelegramAPIError:                     await message.answer(                        f"‚ùå <b>–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã</b>\n\n"                                            f"ID: <code>{target_user_id}</code> –±“±–ª —Ç–æ–ø—Ç–∞ —Ç–∞–±—ã–ª–º–∞–¥—ã.\n\n"                     f"<b>“ö–æ–ª–¥–∞–Ω—É:</b>\n"                     f"‚Ä¢ <code>/info @username</code>\n"                                               f"‚Ä¢ <code>/info user_id</code>\n"                                                 f"‚Ä¢ –•–∞—Ç“õ–∞ –∂–∞—É–∞–ø –±–µ—Ä—ñ–ø <code>/info</code>",                                        parse_mode='HTML'                    )                                        return                           else:                                        # Username –∞—Ä“õ—ã–ª—ã —ñ–∑–¥–µ—É (—Ç–æ–ø –º“Ø—à–µ–ª–µ—Ä—ñ–Ω–µ–Ω)                                         await message.answer(                        f"‚è≥ <b>–Ü–∑–¥–µ—É...</b>\n\n"                f"Username: @{identifier} —ñ–∑–¥–µ–ª—ñ–ø –∂–∞—Ç—ã—Ä...",                                      parse_mode='HTML'                    )                                        # ”ò–∑—ñ—Ä–≥–µ username –∞—Ä“õ—ã–ª—ã —ñ–∑–¥–µ—É “õ–æ–ª–¥–∞—É –∂–æ“õ                                         # Telegram API-–¥–∞ administrators –∞—Ä“õ—ã–ª—ã “ì–∞–Ω–∞ —ñ–∑–¥–µ—É–≥–µ –±–æ–ª–∞–¥—ã                       await message.answer(                        f"‚ùå <b>Username –∞—Ä“õ—ã–ª—ã —ñ–∑–¥–µ—É “õ–æ–ª–¥–∞—É –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–π–¥—ñ</b>\n\n"                       f"–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–Ω—ã“£ —Ö–∞—Ç—ã–Ω–∞ –∂–∞—É–∞–ø –±–µ—Ä—ñ–ø –Ω–µ–º–µ—Å–µ ID –∞—Ä“õ—ã–ª—ã —ñ–∑–¥–µ“£—ñ–∑:\n"                  f"<code>/info user_id</code>",                                                    parse_mode='HTML'                    )                                        return                                                                    # 3. –ï—à“õ–∞–Ω–¥–∞–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∂–æ“õ               else:                                        await message.answer(                        "‚ÑπÔ∏è <b>“ö–æ–ª–¥–∞–Ω—É –Ω“±—Å“õ–∞—É–ª—ã“ì—ã</b>\n\n"                                                 "<code>/info</code> –ø”ô—Ä–º–µ–Ω—ñ–Ω –∫–µ–ª–µ—Å—ñ —Ç”ô—Å—ñ–ª–¥–µ—Ä–º–µ–Ω –ø–∞–π–¥–∞–ª–∞–Ω—É“ì–∞ –±–æ–ª–∞–¥—ã:\n\n"                                                   "<b>1. –•–∞—Ç“õ–∞ –∂–∞—É–∞–ø –±–µ—Ä—É:</b>\n"                                                   "   ‚Ä¢ “ö–æ–ª–¥–∞–Ω—É—à—ã–Ω—ã“£ —Ö–∞—Ç—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑\n"                                              "   ‚Ä¢ ¬´–ñ–∞—É–∞–ø –±–µ—Ä—É¬ª –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑\n"                                          "   ‚Ä¢ <code>/info</code> –¥–µ–ø –∂–∞–∑—ã“£—ã–∑\n\n"                                         "<b>2. Username –∞—Ä“õ—ã–ª—ã:</b>\n"                                                    "   ‚Ä¢ <code>/info @username</code>\n\n"                                           "<b>3. ID –∞—Ä“õ—ã–ª—ã:</b>\n"                 "   ‚Ä¢ <code>/info 123456789</code>\n\n"                                           "<b>–ú—ã—Å–∞–ª–¥–∞—Ä:</b>\n"                     "   <code>/info @shyraqdev</code>\n"                                              "   <code>/info 123456789</code>",                                                parse_mode='HTML'                    )                                        return                                                                        # –ë–æ—Ç —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç —Å“±—Ä–∞–º–∞—É             if target_user and target_user.is_bot:                                                await message.answer("ü§ñ –ë“±–ª –±–æ—Ç —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç –∂–æ“õ.")                            return                                                                        if not target_user_id:                       await message.answer("‚ùå –ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã.")                                 return                                                                        target_name = target_user.full_name if target_user else f"User {target_user_id}"                                           target_username = f"@{target_user.username}" if target_user and target_user.username else "–ñ–æ“õ"                                                                     # –ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä                             warnings = bot_instance.get_warnings(target_user_id, chat_id)                     warning_reasons = bot_instance.get_warning_reasons(target_user_id, chat_id)                                                # “ö–∞—Ç–µ–ª–µ—Ä                                mistakes_count = len(bot_instance.user_mistakes.get(target_user_id, []))          unique_mistakes = len(set(                   m['wrong'] for m in bot_instance.user_mistakes.get(target_user_id, [])        ))                                                                                # –°—Ç–∞—Ç—É—Å                                 if warnings == 0:                            status = "üü¢ ”®—Ç–µ –∂–∞“õ—Å—ã"                  status_emoji = "üòä"                  elif warnings <= 2:                          status = "üü° –ñ–∞“õ—Å—ã"                      status_emoji = "üòê"                  elif warnings <= 4:                          status = "üü† –ù–∞–∑–∞—Ä –∞—É–¥–∞—Ä—ã“£—ã–∑"            status_emoji = "üò¨"                  else:                                        status = "üî¥ “ö–∞—É—ñ–ø—Ç—ñ –∞–π–º–∞“õ"              status_emoji = "üò∞"                                                           # –î–µ“£–≥–µ–π                                 if warnings == 0 and mistakes_count == 0:                                             level = "üèÜ ”®–Ω–µ–≥–µ"                   elif warnings <= 1:                          level = "‚≠ê “Æ–∑–¥—ñ–∫"                   elif warnings <= 3:                          level = "üìù –ñ–∞“õ—Å—ã –æ“õ—É—à—ã"             else:                                        level = "‚ö†Ô∏è –ù–∞–∑–∞—Ä “õ–∞–∂–µ—Ç"                                                       # –ñ–∞–∑–∞–ª–∞—Ä                                punishment_status = ""                   if warnings >= 5:                            punishment_levels = {                        5: "üîá 5 –º–∏–Ω—É—Ç “Ø–Ω—ñ ”©—à—ñ—Ä—ñ–ª–≥–µ–Ω",                                                    6: "üîá 30 –º–∏–Ω—É—Ç “Ø–Ω—ñ ”©—à—ñ—Ä—ñ–ª–≥–µ–Ω",                                                   7: "üîá 1 –∫“Ø–Ω “Ø–Ω—ñ ”©—à—ñ—Ä—ñ–ª–≥–µ–Ω",             8: "üö´ –¢–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—ã–ª“ì–∞–Ω",               9: "‚õî –ë“±“ì–∞—Ç—Ç–∞–ª“ì–∞–Ω"                  }                                        if warnings in punishment_levels:            punishment_status = f"\nüö® <b>–ñ–∞–∑–∞:</b> {punishment_levels[warnings]}"        elif warnings > 9:                           punishment_status = f"\nüö® <b>–ñ–∞–∑–∞:</b> ‚õî –ë“±“ì–∞—Ç—Ç–∞–ª“ì–∞–Ω"                                                            text = (                                     f"‚ÑπÔ∏è <b>“ö–æ–ª–¥–∞–Ω—É—à—ã —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç</b> {status_emoji}\n\n"                           f"<b>–ê—Ç—ã-–∂”©–Ω—ñ:</b> {target_name}\n"                                               f"<b>Username:</b> {target_username}\n"                                           f"<b>ID:</b> <code>{target_user_id}</code>\n\n"                                   f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"               f"‚ö†Ô∏è –ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä: {warnings}/4\n"          f"‚ùå “ö–∞—Ç–µ–ª–µ—Ä: {mistakes_count} ({unique_mistakes} —Ç“Ø—Ä–ª—ñ)\n"                       f"üìà –°—Ç–∞—Ç—É—Å: {status}\n"                 f"üéØ –î–µ“£–≥–µ–π: {level}"                    f"{punishment_status}\n\n"           )                                                                                 # –ï—Å–∫–µ—Ä—Ç—É —Å–µ–±–µ–ø—Ç–µ—Ä—ñ                      if warning_reasons:                          text += "‚ö†Ô∏è <b>–ï—Å–∫–µ—Ä—Ç—É —Å–µ–±–µ–ø—Ç–µ—Ä—ñ:</b>\n"                                           for i, reason_data in enumerate(warning_reasons[-5:], 1):                             reason = reason_data['reason']                                                    text += f"  {i}. {reason}\n"         text += "\n"                                                                  # –ñ–∏—ñ –∫–µ–∑–¥–µ—Å–µ—Ç—ñ–Ω “õ–∞—Ç–µ–ª–µ—Ä (—Ç–æ–ø 3)         if target_user_id in bot_instance.user_mistakes and bot_instance.user_mistakes[target_user_id]:                                mistake_counts = {}                      for mistake in bot_instance.user_mistakes[target_user_id]:                            wrong = mistake['wrong']                 mistake_counts[wrong] = mistake_counts.get(wrong, 0) + 1                                                               top_mistakes = sorted(mistake_counts.items(), key=lambda x: x[1], reverse=True)[:3]                                                                                 if top_mistakes:                             text += "üîù <b>–ñ–∏—ñ –∫–µ–∑–¥–µ—Å–µ—Ç—ñ–Ω “õ–∞—Ç–µ–ª–µ—Ä:</b>\n"                                     for wrong, count in top_mistakes:                                                     # –î“±—Ä—ã—Å –Ω“±—Å“õ–∞—Å—ã–Ω —Ç–∞–±—É                    correct = next(                              (m['correct'] for m in bot_instance.user_mistakes[target_user_id] if m['wrong'] == wrong),                                 "?"                                  )                                        text += f"  ‚Ä¢ {wrong} ‚û°Ô∏è {correct} <i>({count} —Ä–µ—Ç)</i>\n"             else:                                        if warnings > 0:                             text += "‚ÑπÔ∏è <i>–ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä: –æ—Ä—ã—Å—à–∞ —Å”©–∑–¥–µ—Ä –Ω–µ–º–µ—Å–µ —Ç—ñ–ª–¥—ñ –∞—Ä–∞–ª–∞—Å—Ç—ã—Ä—É</i>"          else:                                        text += "‚úÖ <i>“ö–∞—Ç–µ–ª–µ—Ä –∂–æ“õ! ”®—Ç–µ –∂–∞“õ—Å—ã!</i>"                                                                        await message.answer(text, parse_mode='HTML')                                                                                                                   @router.message(Command("stats"))        async def cmd_stats(message: Message):       """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–Ω—ã –∫”©—Ä—Å–µ—Ç–µ–¥—ñ"""             user_id = message.from_user.id           chat_id = message.chat.id                                                         warnings = bot_instance.get_warnings(user_id, chat_id)                            mistakes_count = len(bot_instance.user_mistakes.get(user_id, []))                                                          status = "üü¢ –ñ–∞“õ—Å—ã" if warnings == 0 else "üü° –ù–∞–∑–∞—Ä –∞—É–¥–∞—Ä—ã“£—ã–∑" if warnings < 4 else "üî¥ “ö–∞—É—ñ–ø—Ç—ñ –∞–π–º–∞“õ"                                                              await message.answer(                        f"üìä <b>–°—ñ–∑–¥—ñ“£ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞“£—ã–∑:</b>\n\n"                                            f"üë§ “ö–æ–ª–¥–∞–Ω—É—à—ã: {message.from_user.full_name}\n"                                  f"‚ö†Ô∏è –ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä: {warnings}/4\n"          f"‚ùå “ö–∞—Ç–µ–ª–µ—Ä —Å–∞–Ω—ã: {mistakes_count}\n"                                            f"üìà –°—Ç–∞—Ç—É—Å: {status}\n\n"               f"üí° “ö–∞–∑–∞“õ—à–∞ —Å–∞—É–∞—Ç—Ç—ã –∂–∞–∑—É“ì–∞ —Ç—ã—Ä—ã—Å—ã“£—ã–∑!",                                          parse_mode='HTML'                    )                                                                                                                      @router.message(Command("mistakes"))     async def cmd_mistakes(message: Message):    """“ö–æ–ª–¥–∞–Ω—É—à—ã–Ω—ã“£ “õ–∞—Ç–µ–ª–µ—Ä—ñ–Ω –∫”©—Ä—Å–µ—Ç–µ–¥—ñ"""                                            user_id = message.from_user.id                                                    if user_id not in bot_instance.user_mistakes or not bot_instance.user_mistakes[user_id]:                                       await message.answer("‚úÖ –°—ñ–∑–¥–µ ”ô–∑—ñ—Ä–≥–µ “õ–∞—Ç–µ–ª–µ—Ä –∂–æ“õ! –ñ–∞“õ—Å—ã –∂“±–º—ã—Å!")                 return                                                                        await bot_instance.send_mistakes_to_user(                                             message.bot, user_id,                    "–°—ñ–∑–¥—ñ“£ –∂–∏—ñ –∫–µ–∑–¥–µ—Å–µ—Ç—ñ–Ω “õ–∞—Ç–µ–ª–µ—Ä—ñ“£—ñ–∑"                                           )                                                                                                                      @router.message(Command("test"))         async def cmd_test(message: Message):        """–¢–µ—Å—Ç —Ç–∞–ø—Å—ã—Ä—É (–∂–∞–∑–∞–¥–∞–Ω –±–æ—Å–∞—Ç—É)"""      user_id = message.from_user.id           chat_id = message.chat.id                                                         warnings = bot_instance.get_warnings(user_id, chat_id)                                                                     if warnings < 5:                             await message.answer("‚úÖ –°—ñ–∑–¥–µ –∂–∞–∑–∞ –∂–æ“õ. –¢–µ—Å—Ç —Ç–∞–ø—Å—ã—Ä—É “õ–∞–∂–µ—Ç –µ–º–µ—Å.")               return                                                                        # –¢–µ—Å—Ç —Å“±—Ä–∞“õ—Ç–∞—Ä—ã (–∫–µ–π—ñ–Ω –∫–µ“£–µ–π—Ç—É–≥–µ –±–æ–ª–∞–¥—ã)                                         test_questions = [                           {"wrong": "–±—É–≥—ã–Ω", "correct": "–±“Ø–≥—ñ–Ω"},                                           {"wrong": "—è", "correct": "–º–µ–Ω"},        {"wrong": "—Å–µ–Ω—ã–Ω", "correct": "—Å–µ–Ω—ñ“£"},                                       ]                                                                                 await message.answer(                        "üìù <b>–¢–µ—Å—Ç —Ç–∞–ø—Å—ã—Ä—É</b>\n\n"             "–¢”©–º–µ–Ω–¥–µ–≥—ñ —Å”©–∑–¥–µ—Ä–¥—ñ“£ –¥“±—Ä—ã—Å –Ω“±—Å“õ–∞—Å—ã–Ω –∂–∞–∑—ã“£—ã–∑:\n\n"                                 "1. –±—É–≥—ã–Ω ‚Üí ?\n"                         "2. —è ‚Üí ?\n"                             "3. —Å–µ–Ω—ã–Ω ‚Üí ?\n\n"                       "–ñ–∞—É–∞–ø—Ç—ã –±—ñ—Ä —Ö–∞—Ç—Ç–∞ –∂–∞–∑—ã“£—ã–∑, –º—ã—Å–∞–ª—ã: –±“Ø–≥—ñ–Ω, –º–µ–Ω, —Å–µ–Ω—ñ“£\n\n"                        "‚è∞ 2 –º–∏–Ω—É—Ç —É–∞“õ—ã—Ç—ã“£—ã–∑ –±–∞—Ä.",             parse_mode='HTML'                    )                                                                                 # –¢–µ—Å—Ç –ª–æ–≥–∏–∫–∞—Å—ã–Ω —Ç–æ–ª—ã“õ —ñ—Å–∫–µ –∞—Å—ã—Ä—É “Ø—à—ñ–Ω “õ–æ—Å—ã–º—à–∞ –∫–æ–¥ “õ–∞–∂–µ—Ç                                                                                                        @router.message(Command("addword"))      async def cmd_addword(message: Message):     """–ñ–∞“£–∞ —Å”©–∑ “õ–æ—Å—É (—Ç–µ–∫ ”ô–∫—ñ–º—à—ñ–≥–µ)"""       if message.from_user.id != ADMIN_ID:         await message.answer("‚ùå –ë“±–ª –∫–æ–º–∞–Ω–¥–∞ —Ç–µ–∫ ”ô–∫—ñ–º—à—ñ–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω!")                     return                                                                        # –ö–æ–º–∞–Ω–¥–∞ –º”ô—Ç—ñ–Ω—ñ–Ω –∞–ª—É                    command_text = message.text.strip()      parts = command_text.split(maxsplit=1)                                                                                     # –ï–≥–µ—Ä —Ç–µ–∫ –∫–æ–º–∞–Ω–¥–∞ –±–æ–ª—Å–∞, –Ω“±—Å“õ–∞—É–ª—ã“õ –∫”©—Ä—Å–µ—Ç—É                                       if len(parts) < 2:                           await message.answer(                        "‚ûï <b>–ñ–∞“£–∞ —Å”©–∑ “õ–æ—Å—É</b>\n\n"            "–§–æ—Ä–º–∞—Ç—ã: /addword –±“±—Ä—ã—Å:–¥“±—Ä—ã—Å\n"                                                 "–ú—ã—Å–∞–ª—ã: /addword –±—É–≥—ã–Ω:–±“Ø–≥—ñ–Ω\n\n"                                                "–ù–µ–º–µ—Å–µ –æ—Ä—ã—Å—à–∞ —Å”©–∑ “õ–æ—Å—É:\n"              "/addword russian:—Å–ø–∞—Å–∏–±–æ",              parse_mode='HTML'                    )                                        return                                                                        # –°”©–∑–¥—ñ —Ç–∞–ª–¥–∞—É                           word_data = parts[1].strip()                                                      # –û—Ä—ã—Å—à–∞ —Å”©–∑ “õ–æ—Å—É                        if word_data.startswith('russian:'):         russian_word = word_data.replace('russian:', '').strip().lower()                  if russian_word:                             bot_instance.russian_words.add(russian_word)                                                                               # –§–∞–π–ª“ì–∞ —Å–∞“õ—Ç–∞—É                          bot_instance.save_dictionary()                                                                                             await message.answer(                        f"‚úÖ –û—Ä—ã—Å—à–∞ —Å”©–∑ “õ–æ—Å—ã–ª–¥—ã –∂”ô–Ω–µ —Å–∞“õ—Ç–∞–ª–¥—ã: <b>{russian_word}</b>\n\n"                 f"–ñ–∞–ª–ø—ã –æ—Ä—ã—Å—à–∞ —Å”©–∑–¥–µ—Ä: {len(bot_instance.russian_words)}",                        parse_mode='HTML'                    )                                    else:                                        await message.answer("‚ùå –°”©–∑ –∂–∞–∑—ã–ª–º–∞“ì–∞–Ω!")                                    return                                                                        # –ë“±—Ä—ã—Å:–¥“±—Ä—ã—Å —Ñ–æ—Ä–º–∞—Ç—ã–Ω —Ç–µ–∫—Å–µ—Ä—É           if ':' not in word_data:                     await message.answer(                        "‚ùå “ö–∞—Ç–µ —Ñ–æ—Ä–º–∞—Ç!\n\n"                    "–î“±—Ä—ã—Å —Ñ–æ—Ä–º–∞—Ç: /addword –±“±—Ä—ã—Å:–¥“±—Ä—ã—Å\n"                                            "–ú—ã—Å–∞–ª—ã: /addword —Å–µ–Ω—ñ–Ω:—Å–µ–Ω—ñ“£"                                                )                                        return                                                                        # –°”©–∑–¥–µ—Ä–¥—ñ –±”©–ª—É                          try:                                         wrong, correct = word_data.split(':', 1)                                          wrong = wrong.strip().lower()            correct = correct.strip()                                                         if not wrong or not correct:                 await message.answer("‚ùå –ë“±—Ä—ã—Å –Ω–µ–º–µ—Å–µ –¥“±—Ä—ã—Å —Å”©–∑ –∂–∞–∑—ã–ª–º–∞“ì–∞–Ω!")                     return                                                                        # –°”©–∑–¥—ñ–∫–∫–µ “õ–æ—Å—É                          bot_instance.wrong_words[wrong] = correct                                                                                  # –§–∞–π–ª“ì–∞ —Å–∞“õ—Ç–∞—É                          bot_instance.save_dictionary()                                                    await message.answer(                        f"‚úÖ –°”©–∑ —Å”©–∑–¥—ñ–∫–∫–µ “õ–æ—Å—ã–ª–¥—ã –∂”ô–Ω–µ —Å–∞“õ—Ç–∞–ª–¥—ã!\n\n"                                     f"‚ùå –ë“±—Ä—ã—Å: <b>{wrong}</b>\n"            f"‚úÖ –î“±—Ä—ã—Å: <b>{correct}</b>\n\n"                                                 f"–ñ–∞–ª–ø—ã —Å”©–∑–¥–µ—Ä: {len(bot_instance.wrong_words)}",                                 parse_mode='HTML'                    )                                                                             except Exception as e:                       await message.answer(f"‚ùå “ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã: {e}")                                                                                                             @router.message(Command("reset"))        async def cmd_reset(message: Message):       """–ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä–¥—ñ —Ç–∞—Å—Ç–∞–π–¥—ã (—Ç–µ–∫ ”ô–∫—ñ–º—à—ñ–≥–µ)"""                                        if message.from_user.id != ADMIN_ID:         await message.answer("‚ùå –ë“±–ª –∫–æ–º–∞–Ω–¥–∞ —Ç–µ–∫ ”ô–∫—ñ–º—à—ñ–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω!")                     return                                                                        # Inline –±–∞—Ç—ã—Ä–º–∞–ª–∞—Ä                      keyboard = InlineKeyboardMarkup(inline_keyboard=[                                     [                                            InlineKeyboardButton(text="‚ùå –ë–∞—Å —Ç–∞—Ä—Ç—É", callback_data="reset_cancel"),                                                   InlineKeyboardButton(text="‚úÖ –†–∞—Å—Ç–∞—É", callback_data="reset_confirm")         ]                                    ])                                                                                await message.answer(                        "‚ö†Ô∏è <b>–ù–∞–∑–∞—Ä –∞—É–¥–∞—Ä—ã“£—ã–∑!</b>\n\n"          "–°—ñ–∑ –±–∞—Ä–ª—ã“õ “õ–æ–ª–¥–∞–Ω—É—à—ã–Ω—ã“£ –µ—Å–∫–µ—Ä—Ç—É—ñ –º–µ–Ω “õ–∞—Ç–µ—Å—ñ–Ω –∞–ª—ã–ø —Ç–∞—Å—Ç–∞–º–∞“õ—à—ã—Å—ã–∑.\n\n"            "–ê–ª—ã–ø —Ç–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?",                    reply_markup=keyboard,                   parse_mode='HTML'                    )                                                                                                                      @router.callback_query(F.data == "reset_cancel")                                  async def reset_cancel(callback: CallbackQuery):                                      """Reset –±–∞—Å —Ç–∞—Ä—Ç—É"""                    if callback.from_user.id != ADMIN_ID:        await callback.answer("‚ùå –ë“±–ª —Å—ñ–∑–≥–µ –∞—Ä–Ω–∞–ª–º–∞“ì–∞–Ω!", show_alert=True)                return                                                                        await callback.message.edit_text(            "‚ùå <b>–ë–∞—Å —Ç–∞—Ä—Ç—ã–ª–¥—ã</b>\n\n"             "–°—ñ–∑ –±“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ —ñ—Å–∫–µ –∞—Å—ã—Ä—É–¥–∞–Ω –±–∞—Å —Ç–∞—Ä—Ç—Ç—ã“£—ã–∑.",                                  parse_mode='HTML'                    )                                        await callback.answer()                                                                                                @router.callback_query(F.data == "reset_confirm")                                 async def reset_confirm(callback: CallbackQuery):                                     """Reset —Ä–∞—Å—Ç–∞—É"""                       if callback.from_user.id != ADMIN_ID:        await callback.answer("‚ùå –ë“±–ª —Å—ñ–∑–≥–µ –∞—Ä–Ω–∞–ª–º–∞“ì–∞–Ω!", show_alert=True)                return                                                                        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–ª—É                         total_warnings = sum(len(chats) for chats in bot_instance.user_warnings.values())                                          total_mistakes = sum(len(mistakes) for mistakes in bot_instance.user_mistakes.values())                                    total_users = len(set(list(bot_instance.user_warnings.keys()) + list(bot_instance.user_mistakes.keys())))                                                           # –¢–∞—Å—Ç–∞—É                                 bot_instance.user_warnings.clear()       bot_instance.user_mistakes.clear()                                                await callback.message.edit_text(            "‚úÖ <b>“ö–∞–±—ã–ª–¥–∞–Ω–¥—ã</b>\n\n"               "–°—ñ–∑ –±–∞—Ä–ª—ã“õ “õ–æ–ª–¥–∞–Ω—É—à—ã–Ω—ã“£ –∫“Ø–π—ñ–Ω –∂–∞“£–∞—Ä—Ç—Ç—ã“£—ã–∑.\n\n"                                  f"üìä <b>–¢–∞—Å—Ç–∞–ª“ì–∞–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä:</b>\n"                                                f"üë• “ö–æ–ª–¥–∞–Ω—É—à—ã–ª–∞—Ä: {total_users}\n"                                               f"‚ö†Ô∏è –ï—Å–∫–µ—Ä—Ç—É–ª–µ—Ä: {total_warnings}\n"                                               f"‚ùå “ö–∞—Ç–µ–ª–µ—Ä: {total_mistakes}",         parse_mode='HTML'                    )                                        await callback.answer("‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä —Ç–∞—Å—Ç–∞–ª–¥—ã!", show_alert=True)                                                                                                 # Inline —Ä–µ–∂–∏–º                           @router.inline_query()                   async def inline_query_handler(inline_query: InlineQuery):                            """Inline —Ä–µ–∂–∏–º - –º”ô—Ç—ñ–Ω–¥—ñ —Ç–µ–∫—Å–µ—Ä—É"""     query_text = inline_query.query.strip()                                                                                    if not query_text:                           # –ë–æ—Å —Å“±—Ä–∞—É - –Ω“±—Å“õ–∞—É–ª—ã“õ                  results = [                                  InlineQueryResultArticle(                    id="help",                               title="üìù –ú”ô—Ç—ñ–Ω–¥—ñ —Ç–µ–∫—Å–µ—Ä—É",                                                       description="–ú”ô—Ç—ñ–Ω–¥—ñ –∂–∞–∑—ã–ø, “õ–∞–∑–∞“õ—à–∞ –¥“±—Ä—ã—Å –µ–∫–µ–Ω—ñ–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑",                     input_message_content=InputTextMessageContent(                                        message_text=(                               "üìù <b>“ö–∞–∑–∞“õ—à–∞ –°–∞—É–∞—Ç—Ç—ã –ñ–∞–∑</b>\n\n"                                               "–ú”ô—Ç—ñ–Ω–¥—ñ inline —Ä–µ–∂–∏–º–¥–µ —Ç–µ–∫—Å–µ—Ä—É “Ø—à—ñ–Ω:\n"                                          "1. –ö–µ–∑ –∫–µ–ª–≥–µ–Ω —á–∞—Ç—Ç–∞ <code>@your_bot_username</code> –¥–µ–ø –∂–∞–∑—ã“£—ã–∑\n"                                                        "2. –¢–µ–∫—Å–µ—Ä–≥—ñ“£—ñ–∑ –∫–µ–ª–≥–µ–Ω –º”ô—Ç—ñ–Ω–¥—ñ –∂–∞–∑—ã“£—ã–∑\n"                                         "3. –ù”ô—Ç–∏–∂–µ–Ω—ñ —Ç–∞“£–¥–∞–ø –∂—ñ–±–µ—Ä—ñ“£—ñ–∑\n\n"                                                "–ú—ã—Å–∞–ª—ã: <code>@your_bot_username —Å–∞–ª–∞–º –¥–æ—Å—Ç–∞—Ä –±—É–≥—ã–Ω “õ–∞–ª–∞–π—Å—ã–Ω–¥–∞—Ä</code>"                                               ),                                       parse_mode='HTML'                    ),                                       thumbnail_url="https://img.icons8.com/color/96/000000/checkmark.png"                                                   )                                    ]                                        await inline_query.answer(results, cache_time=300)                                return                                                                        # –ú”ô—Ç—ñ–Ω–¥—ñ —Ç–µ–∫—Å–µ—Ä—É                        issues = []                              corrections = []                                                                  # FastText –∞—Ä“õ—ã–ª—ã —Ç—ñ–ª –∞–Ω—ã“õ—Ç–∞—É            is_kazakh, confidence = bot_instance.is_text_kazakh(query_text)                                                            if not is_kazakh and confidence > 0.5:                                                issues.append(f"üá∑üá∫ –û—Ä—ã—Å—à–∞ –º”ô—Ç—ñ–Ω –∞–Ω—ã“õ—Ç–∞–ª–¥—ã ({confidence:.0%})")                                                         # –û—Ä—ã—Å—à–∞ —Å”©–∑–¥–µ—Ä                          russian_words = bot_instance.check_russian_words(query_text)                      if russian_words:                            issues.append(f"üá∑üá∫ –û—Ä—ã—Å—à–∞: {', '.join(russian_words[:5])}")                                                            # “ö–∞—Ç–µ —Å”©–∑–¥–µ—Ä                            wrong_words = bot_instance.check_wrong_words(query_text)                          if wrong_words:                              for mistake in wrong_words:                  corrections.append(f"{mistake['wrong']} ‚Üí {mistake['correct']}")                                                   # –ê—Ä–∞–ª–∞—Å—Ç—ã—Ä—É                             mixed = bot_instance.check_mixed_language(query_text)                             if mixed:                                    issues.append("‚ö†Ô∏è –¢—ñ–ª–¥–µ—Ä–¥—ñ –∞—Ä–∞–ª–∞—Å—Ç—ã—Ä–º–∞“£—ã–∑")                                                                             # –ù”ô—Ç–∏–∂–µ “õ“±—Ä—É                            results = []                                                                      if not issues and not corrections:           # –ë–∞—Ä–ª—ã“ì—ã –¥“±—Ä—ã—Å                          results.append(                              InlineQueryResultArticle(                    id="correct",                            title="‚úÖ –ú”ô—Ç—ñ–Ω –¥“±—Ä—ã—Å –∂–∞–∑—ã–ª“ì–∞–Ω!",                                                 description="–ë–∞—Ä–ª—ã“õ —Ç–µ–∫—Å–µ—Ä—É–ª–µ—Ä ”©—Ç—Ç—ñ. “ö–∞—Ç–µ–ª–µ—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã.",                         input_message_content=InputTextMessageContent(                                        message_text=(                               f"‚úÖ <b>–¢–µ–∫—Å–µ—Ä—É –Ω”ô—Ç–∏–∂–µ—Å—ñ</b>\n\n"                                                 f"<i>{query_text}</i>\n\n"                                                        f"üéâ –ú”ô—Ç—ñ–Ω –¥“±—Ä—ã—Å –∂–∞–∑—ã–ª“ì–∞–Ω!\n"                                                     f"–ë–∞—Ä–ª—ã“õ —Ç–µ–∫—Å–µ—Ä—É–ª–µ—Ä ”©—Ç—Ç—ñ."                                                    ),                                       parse_mode='HTML'                    ),                                       thumbnail_url="https://img.icons8.com/color/96/000000/checkmark.png"                                                   )                                    )                                    else:                                        # “ö–∞—Ç–µ–ª–µ—Ä —Ç–∞–±—ã–ª–¥—ã                        error_text = "üìù <b>–¢–µ–∫—Å–µ—Ä—É –Ω”ô—Ç–∏–∂–µ—Å—ñ</b>\n\n"                                     error_text += f"<b>–¢“Ø–ø–Ω“±—Å“õ–∞:</b>\n<i>{query_text}</i>\n\n"                                                                 if issues:                                   error_text += "<b>‚ö†Ô∏è –ú”ô—Å–µ–ª–µ–ª–µ—Ä:</b>\n"                                             for issue in issues:                         error_text += f"‚Ä¢ {issue}\n"                                                  error_text += "\n"                                                            if corrections:
            error_text += "<b>üìù –¢“Ø–∑–µ—Ç—É–ª–µ—Ä:</b>\n"                                            for correction in corrections:                                                        error_text += f"‚Ä¢ {correction}\n"                                             error_text += "\n"                                                            # –¢“Ø–∑–µ—Ç—ñ–ª–≥–µ–Ω –Ω“±—Å“õ–∞                       corrected_text = query_text              for mistake in wrong_words:                  corrected_text = corrected_text.replace(mistake['wrong'], mistake['correct'])                                                                                   error_text += f"<b>‚úÖ –¢“Ø–∑–µ—Ç—ñ–ª–≥–µ–Ω –Ω“±—Å“õ–∞:</b>\n<i>{corrected_text}</i>"                                                      results.append(                              InlineQueryResultArticle(                    id="errors",                             title=f"‚ùå {len(issues) + len(corrections)} “õ–∞—Ç–µ —Ç–∞–±—ã–ª–¥—ã",                        description=f"“ö–∞—Ç–µ–ª–µ—Ä: {', '.join([i.split(':')[0] for i in issues[:3]])}",                                                input_message_content=InputTextMessageContent(                                        message_text=error_text,                                                          parse_mode='HTML'                    ),                                       thumbnail_url="https://img.icons8.com/color/96/000000/error.png"              )                                    )                                                                                 # –¢–µ–∫ —Ç“Ø–∑–µ—Ç—ñ–ª–≥–µ–Ω –Ω“±—Å“õ–∞                   if corrections:                              results.append(                              InlineQueryResultArticle(                    id="corrected",                          title="‚úÖ –¢“Ø–∑–µ—Ç—ñ–ª–≥–µ–Ω –Ω“±—Å“õ–∞",                                                      description=corrected_text[:100],                                                 input_message_content=InputTextMessageContent(                                        message_text=corrected_text                                                   ),                                       thumbnail_url="https://img.icons8.com/color/96/000000/edit.png"                                                        )                                    )                                                                         await inline_query.answer(results, cache_time=INLINE_CACHE_TIME)                                                                                                # –ñ–∞“£–∞ –º“Ø—à–µ–ª–µ—Ä–¥—ñ “õ–∞–±—ã–ª–¥–∞—É                @router.chat_member(ChatMemberUpdatedFilter(IS_NOT_MEMBER >> IS_MEMBER))          async def on_user_join(event: ChatMemberUpdated):                                     """–ñ–∞“£–∞ –º“Ø—à–µ —Ç–æ–ø“õ–∞ “õ–æ—Å—ã–ª“ì–∞–Ω–¥–∞"""         user = event.new_chat_member.user        chat_id = event.chat.id                                                           # ”®–∑—ñ“£–¥—ñ –Ω–µ–º–µ—Å–µ –±–æ—Ç—Ç—ã ”©—Ç–∫—ñ–∑—ñ–ø –∂—ñ–±–µ—Ä—É     if user.is_bot:                              return                                                                        # 1Ô∏è‚É£ “ö–æ—à –∫–µ–ª–¥—ñ“£ —Ö–∞–±–∞—Ä—ã                    mention = f"<a href='tg://user?id={user.id}'>{user.first_name}</a>"               welcome_msg = (                              f"üëã {mention} –¥–æ—Å—ã–º, “õ–æ—à –∫–µ–ª–¥—ñ“£! –ú–µ–Ω —Å–µ–Ω—ñ –∫”©—Ä–≥–µ–Ω—ñ–º–µ “õ—É–∞–Ω—ã—à—Ç—ã–º—ã–Ω! "               f"–ê–ª–¥–∞“ì—ã —É–∞“õ—ã—Ç—Ç–∞ –±—ñ—Ä–≥–µ —Ç–∞–ª–∞–π “õ—ã–∑—ã“õ—Ç—ã –±–∞—Å—Ç–∞–Ω ”©—Ç–∫–µ—Ä—ñ–ø, –∂–µ—Ç—ñ—Å—Ç—ñ–∫–∫–µ –∂–µ—Ç–µ–º—ñ–∑ ü´∂"                                            )                                                                                 await event.answer(welcome_msg, parse_mode='HTML')                                                                         # 2-5 —Å–µ–∫—É–Ω–¥ –∫“Ø—Ç—É                        await asyncio.sleep(3)                                                            # 2Ô∏è‚É£ –¢—ñ–ª–¥—ñ —Ç–µ–∫—Å–µ—Ä—É                        try:                                         chat_member = await event.bot.get_chat_member(chat_id, user.id)                   user_info = chat_member.user                                                      if bot_instance.is_language_kazakh(user_info.language_code):                          # –¢—ñ–ª—ñ “õ–∞–∑–∞“õ—à–∞                           await event.answer(                          f"“ö–∞–Ω–µ, –¥–æ—Å—ã–º, –∂–∞–π“ì–∞—Å–∞ “ì–æ–π, –æ—Ä—Ç–∞–º—ã–∑“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£! üòä",                            parse_mode='HTML'                    )                                    else:                                        # –¢—ñ–ª—ñ –æ—Ä—ã—Å—à–∞ –Ω–µ–º–µ—Å–µ –±–∞—Å“õ–∞               bot_instance.add_pending_user(user.id, chat_id)                                                                            await event.answer(                          f"–ë—ñ—Ä–∞“õ –±—ñ—Ä —Å”ô—Ç‚Ä¶ ü´£\n\n"                 f"–°–µ–Ω—ñ“£ Telegram-—ã“£ –æ—Ä—ã—Å —Ç—ñ–ª—ñ–Ω–¥–µ —Ç“±—Ä –µ–∫–µ–Ω. –ë—ñ–∑ –º“±–Ω–¥–∞ —Ç–µ–∫ “õ–∞–∑–∞“õ—à–∞ —Å”©–π–ª–µ–π–º—ñ–∑.\n\n"                                           f"<b>–ë–∞–ø—Ç–∞—É–ª–∞—Ä ‚Üí –¢—ñ–ª ‚Üí “ö–∞–∑–∞“õ —Ç—ñ–ª—ñ</b>\n\n"                                        f"”®–∑–≥–µ—Ä—Ç —Ç–µ, “õ–∞–π—Ç—ã–ø –∫–µ–ª. –°–µ–Ω—ñ –∫“Ø—Ç—ñ–ø –æ—Ç—ã—Ä–º—ã–∑ üòå\n\n"                               f"‚è∞ 60 —Å–µ–∫—É–Ω–¥ —É–∞“õ—ã—Ç—ã“£ –±–∞—Ä!",                                                     parse_mode='HTML'                    )                                                                                 # –§–æ–Ω–¥—ã“õ —Ç–µ–∫—Å–µ—Ä—É –±–∞—Å—Ç–∞—É                  asyncio.create_task(check_language_change(event.bot, user.id, chat_id, user.first_name))                                                                    except TelegramAPIError as e:                logger.error(f"–¢—ñ–ª–¥—ñ —Ç–µ–∫—Å–µ—Ä—É–¥–µ “õ–∞—Ç–µ: {e}")                                                                                                                  @router.chat_member(ChatMemberUpdatedFilter(IS_MEMBER >> IS_NOT_MEMBER))          async def on_user_leave(event: ChatMemberUpdated):                                    """–ú“Ø—à–µ —Ç–æ–ø—Ç–∞–Ω —à—ã“õ“õ–∞–Ω–¥–∞"""               user = event.old_chat_member.user                                                 if user.is_bot:                              return                                                                        mention = f"<a href='tg://user?id={user.id}'>{user.first_name}</a>"                                                        # –ï–≥–µ—Ä –∫“Ø—Ç—ñ–ª–µ—Ç—ñ–Ω “õ–æ–ª–¥–∞–Ω—É—à—ã –±–æ–ª—Å–∞         if user.id in bot_instance.pending_users:                                             bot_instance.remove_pending_user(user.id)                                                                              await event.answer(                          f"{mention} –¥–æ—Å—ã–º, –º“±–Ω—ã“£ –Ω–µ ü•π\n"        f"–ñ–∞—Ä–∞–π–¥—ã, —Ç–∞“ì—ã –¥–∞ –±—ñ—Ä –∫”©—Ä—ñ—Å–µ–º—ñ–∑ –¥–µ–≥–µ–Ω –æ–π–¥–∞–º—ã–Ω ü´∂",                               parse_mode='HTML'                    )                                                                                                                      async def check_language_change(bot: Bot, user_id: int, chat_id: int, user_name: str):                                         """–¢—ñ–ª ”©–∑–≥–µ—Ä—ñ—Å—ñ–Ω —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ"""            mention = f"<a href='tg://user?id={user_id}'>{user_name}</a>"                                                              # –ñ–∞“£–∞ —É–∞“õ—ã—Ç –±–µ–ª–≥—ñ–ª–µ—Ä—ñ (—Å–µ–∫—É–Ω–¥—Ç–∞—Ä)       check_times = [5, 10, 20, 30, 60]  # 5—Å, 10—Å, 20—Å, 30—Å, 60—Å                                                                for i, wait_time in enumerate(check_times):                                           if i > 0:                                    await asyncio.sleep(check_times[i] - check_times[i-1])                        else:                                        await asyncio.sleep(wait_time)                                                                                         # “ö–æ–ª–¥–∞–Ω—É—à—ã —Ç—ñ–∑—ñ–º–Ω–µ–Ω –∞–ª—ã–Ω—ã–ø —Ç–∞—Å—Ç–∞–ª“ì–∞–Ω –±–∞?                                         if user_id not in bot_instance.pending_users:                                         return                                                                        try:                                         # “ö–æ–ª–¥–∞–Ω—É—à—ã ”ô–ª—ñ —Ç–æ–ø—Ç–∞ –º–∞?                try:                                         chat_member = await bot.get_chat_member(chat_id, user_id)                     except TelegramAPIError as e:                # –ë–æ—Ç —Ç–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—ã–ª“ì–∞–Ω –Ω–µ–º–µ—Å–µ —Ç–æ–ø –∂–æ“õ                                            if "kicked" in str(e).lower() or "not found" in str(e).lower():                       logger.warning(f"–ë–æ—Ç —Ç–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—ã–ª“ì–∞–Ω –Ω–µ–º–µ—Å–µ —Ç–æ–ø —Ç–∞–±—ã–ª–º–∞–¥—ã: {chat_id}")                                                   bot_instance.remove_pending_user(user_id)                                         return                               raise                                                                         if chat_member.status in ['left', 'kicked', 'banned']:                                bot_instance.remove_pending_user(user_id)                                         return                                                                        # –¢—ñ–ª–¥—ñ —Ç–µ–∫—Å–µ—Ä—É                          if bot_instance.is_language_kazakh(chat_member.user.language_code):                   # –¢—ñ–ª—ñ ”©–∑–≥–µ—Ä–¥—ñ!                          bot_instance.remove_pending_user(user_id)                                         try:                                         await bot.send_message(                                                               chat_id=chat_id,                         text=f"“ö–∞–Ω–µ, –¥–æ—Å—ã–º, –∫—ñ—Ä–µ “ì–æ–π, –∂–∞–π“ì–∞—Å! –û—Ä—Ç–∞–º—ã–∑“ì–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£! üéâ",                                                           parse_mode='HTML'                    )                                    except TelegramAPIError as e:                                                         logger.error(f"–•–∞—Ç –∂—ñ–±–µ—Ä—É–¥–µ “õ–∞—Ç–µ: {e}")                                       return                                                                        # ”ò–ª—ñ –¥–µ ”©–∑–≥–µ—Ä—Ç–∫–µ–Ω –∂–æ“õ - –µ—Å–∫–µ—Ä—Ç—É –∂—ñ–±–µ—Ä–µ–¥—ñ                                         elapsed = check_times[i]                                                          messages = {                                 5: "–ï–π –¥–æ—Å—ã–º, —Ç–µ–∑—ñ—Ä–µ–∫ –∞—É—ã—Å—Ç—ã—Ä—Å–∞“£—à—ã... ‚è∞",                                        10: "–ö“Ø—Ç–∫–µ–Ω—ñ–º–µ –±—ñ—Ä–∞–∑ –±–æ–ª–¥—ã “ì–æ–π... –ë–æ–ª–∞ “ì–æ–π –µ–Ω–¥—ñ... ü•∫",                           20: "–î–æ—Å—ã–º, “õ–æ–ª—ã“£–Ω–∞–Ω –∫–µ–ª–µ –º–µ –µ–∫–µ–Ω... –£–∞“õ—ã—Ç –∞–∑ “õ–∞–ª–¥—ã... ‚è≥",                       30: "”ò–π, –¥–æ—Å—ã–º... ”ô–ª—ñ –∞—É—ã—Å—Ç—ã—Ä–º–∞–ø—Å—ã“£ “ì–æ–π ü•π\n–°–µ–Ω ”ô—É–µ–ª—ñ “õ“±—Ä—ã–ª“ì—ã“£–Ω—ã“£ —Ç—ñ–ª—ñ–Ω –∞—É—ã—Å—Ç—ã—Ä—ã–ø –∫–µ–ª, –º–µ–Ω –∫“Ø—Ç–µ —Ç“±—Ä–∞–º—ã–Ω..."            }                                                                                 if elapsed in messages:                      try:                                         await bot.send_message(                                                               chat_id=chat_id,                         text=messages[elapsed],                                                           parse_mode='HTML'                    )                                    except TelegramAPIError as e:                                                         if "kicked" in str(e).lower() or "forbidden" in str(e).lower():                                                                logger.warning(f"–ë–æ—Ç —Ç–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—ã–ª“ì–∞–Ω: {chat_id}")                               bot_instance.remove_pending_user(user_id)                                         return                               logger.error(f"–•–∞—Ç –∂—ñ–±–µ—Ä—É–¥–µ “õ–∞—Ç–µ: {e}")                                                                            elif elapsed == 60:  # 60 —Å–µ–∫—É–Ω–¥ (—Å–æ“£“ì—ã)                                              # –£–∞“õ—ã—Ç ”©—Ç—Ç—ñ - —à—ã“ì–∞—Ä—É                    try:                                         await bot.ban_chat_member(chat_id=chat_id, user_id=user_id)                       await asyncio.sleep(1)                                                            await bot.unban_chat_member(chat_id=chat_id, user_id=user_id)                                                              bot_instance.remove_pending_user(user_id)                                                                                  await bot.send_message(                                                               chat_id=chat_id,                         text=f"‚úåÔ∏è –°–∞–ø–∞—Ä—ã“£ —Å”ô—Ç—Ç—ñ –±–æ–ª“ì–∞–π!\n"                                                      f"–ë“±–ª —á–∞—Ç “õ–∞–∑–∞“õ—à–∞ –∫–µ“£—ñ—Å—Ç—ñ–∫.\n\n"                                                  f"–¢”ô—Ä—Ç—ñ–ø –±”ô—Ä—ñ–Ω–µ –æ—Ä—Ç–∞“õ. –ë—ñ–∑ —Å–µ–Ω—ñ–º–µ–Ω –æ—Å—ã —Ç“±—Å—Ç–∞ “õ–æ—à—Ç–∞—Å–∞–º—ã–∑...\n"                                                              f"–ñ–æ–ª—ã“£ –±–æ–ª—Å—ã–Ω, –∞“õ –∂–æ–ª! üëã",                                                 parse_mode='HTML'                    )                                    except TelegramAPIError as e:                                                         if "kicked" in str(e).lower() or "forbidden" in str(e).lower():                                                                logger.warning(f"–ë–æ—Ç —Ç–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—ã–ª“ì–∞–Ω: {chat_id}")                           else:                                        logger.error(f"“ö–æ–ª–¥–∞–Ω—É—à—ã–Ω—ã —à—ã“ì–∞—Ä—É–¥–∞ “õ–∞—Ç–µ: {e}")                               bot_instance.remove_pending_user(user_id)                                     return                                                                    except TelegramAPIError as e:                # –ë–∞—Å“õ–∞ “õ–∞—Ç–µ–ª–µ—Ä–¥—ñ ”©“£–¥–µ—É                  if "kicked" in str(e).lower() or "forbidden" in str(e).lower():                       logger.warning(f"–ë–æ—Ç —Ç–æ–ø—Ç–∞–Ω —à—ã“ì–∞—Ä—ã–ª“ì–∞–Ω: {chat_id}")                           else:                                        logger.error(f"–¢–µ–∫—Å–µ—Ä—É–¥–µ “õ–∞—Ç–µ: {e}")                                          bot_instance.remove_pending_user(user_id)                                         return                                                                                                         @router.message(F.text & ~F.text.startswith('/') & ~F.text.startswith('.') & ~F.text.startswith('@'))                      async def check_message(message: Message):                                            """”ò—Ä–±—ñ—Ä —Ö–∞—Ç—Ç—ã —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ (–∫–æ–º–∞–Ω–¥–∞–ª–∞—Ä–¥–∞–Ω –±–∞—Å“õ–∞)"""                                                                          text = message.text                      user_id = message.from_user.id           chat_id = message.chat.id                user_name = message.from_user.full_name                                                                                    issues = []                              mistakes_list = []                                                                # FastText –∞—Ä“õ—ã–ª—ã —Ç—ñ–ª–¥—ñ –∞–Ω—ã“õ—Ç–∞—É          is_kazakh, confidence = bot_instance.is_text_kazakh(text)                                                                  if not is_kazakh and confidence > 0.5:                                                issues.append(f"üá∑üá∫ –û—Ä—ã—Å—à–∞ –∂–∞–∑–±–∞“£—ã–∑! (–°–µ–Ω—ñ–º–¥—ñ–ª—ñ–∫: {confidence:.0%})")                                                   # –û—Ä—ã—Å—à–∞ —Å”©–∑–¥–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä—É                russian_words = bot_instance.check_russian_words(text)                            if russian_words and not issues:             issues.append(f"üá∑üá∫ –û—Ä—ã—Å—à–∞ —Å”©–∑–¥–µ—Ä: {', '.join(russian_words[:3])}")                                                     # –ë“±—Ä—ã—Å —Å”©–∑–¥–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä—É                 wrong_words = bot_instance.check_wrong_words(text)                                if wrong_words:                              corrections = [f"{m['wrong']} ‚û°Ô∏è {m['correct']}" for m in wrong_words[:3]]         issues.append(f"‚ùå “ö–∞—Ç–µ –∂–∞–∑—ã–ª“ì–∞–Ω: {', '.join(corrections)}")                      mistakes_list.extend(wrong_words)                                             # –ê—Ä–∞–ª–∞—Å—Ç—ã—Ä—ã–ø –∂–∞–∑—É–¥—ã —Ç–µ–∫—Å–µ—Ä—É             mixed = bot_instance.check_mixed_language(text)                                   if mixed:                                    issues.append(f"‚ö†Ô∏è –¢—ñ–ª–¥–µ—Ä–¥—ñ –∞—Ä–∞–ª–∞—Å—Ç—ã—Ä–º–∞“£—ã–∑!")                                                                           # –ï–≥–µ—Ä “õ–∞—Ç–µ —Ç–∞–±—ã–ª—Å–∞                      if issues:                                   reason = None                            if not is_kazakh and confidence > 0.5:                                                reason = "–û—Ä—ã—Å—à–∞ –º”ô—Ç—ñ–Ω"              elif russian_words:                          reason = f"–û—Ä—ã—Å—à–∞ —Å”©–∑–¥–µ—Ä: {', '.join(russian_words[:2])}"                     elif wrong_words:                            reason = f"“ö–∞—Ç–µ —Å”©–∑–¥–µ—Ä: {', '.join([m['wrong'] for m in wrong_words[:2]])}"                                            elif mixed:                                  reason = "–¢—ñ–ª–¥–µ—Ä–¥—ñ –∞—Ä–∞–ª–∞—Å—Ç—ã—Ä—É"                                                                                         warning_count = bot_instance.add_warning(user_id, chat_id, reason)                bot_instance.add_mistake(user_id, mistakes_list)                                                                           if warning_count <= WARNING_LIMIT:                                                    warning_msg = f"‚ö†Ô∏è <b>–ï—Å–∫–µ—Ä—Ç—É #{warning_count}/{WARNING_LIMIT}</b> - {user_name}\n\n"                                       warning_msg += "\n".join(issues)                                                  warning_msg += "\n\nüìù “ö–∞–∑–∞“õ—à–∞ —Å–∞—É–∞—Ç—Ç—ã –∂–∞–∑—ã“£—ã–∑!"                                                                           await message.reply(warning_msg, parse_mode='HTML')                           else:                                        punishment = await bot_instance.apply_punishment(message.bot, message, warning_count)                                                                               if punishment:                               await message.reply(                         f"üö® <b>{user_name}</b>\n\n{punishment}\n\n"                                      f"–°–µ–±–µ–±—ñ: {warning_count - WARNING_LIMIT} —Ä–µ—Ç –µ—Å–∫–µ—Ä—Ç—É–¥—ñ –µ–ª–µ–º–µ–¥—ñ“£—ñ–∑",                                                       parse_mode='HTML'                    )                                                                                 await bot_instance.send_mistakes_to_user(                                             message.bot, user_id,                                                             f"–ñ–∞–∑–∞ –∞–ª—É —Å–µ–±–µ–±—ñ: {warning_count - WARNING_LIMIT} —Ä–µ—Ç –µ—Å–∫–µ—Ä—Ç—É"                                                        )                                                                                                          async def main():
    """–ë–æ—Ç—Ç—ã —ñ—Å–∫–µ “õ–æ—Å–∞–¥—ã"""                  bot = Bot(token=BOT_TOKEN)               dp = Dispatcher()                                                                 # bot_instance-—Ç—ã –±–∞—Ä–ª—ã“õ —Ö–µ–Ω–¥–ª–µ—Ä–≥–µ –∂—ñ–±–µ—Ä—É                                         dp["bot_instance"] = bot_instance                                                 # –ú–ê“¢–´–ó–î–´: Router-–ª–µ—Ä–¥—ñ –¥“±—Ä—ã—Å —Ä–µ—Ç–ø–µ–Ω “õ–æ—Å—É                                         # –ê–ª–¥—ã–º–µ–Ω –Ω–∞“õ—Ç—ã –∫–æ–º–∞–Ω–¥–∞–ª–∞—Ä, —Å–æ“£—ã–Ω–¥–∞ –∂–∞–ª–ø—ã —Ñ–∏–ª—å—Ç—Ä–ª–µ—Ä                                                                        try:                                         # Admin –ø–∞–Ω–µ–ª—ñ–Ω “õ–æ—Å—É (callback-—Ç–∞—Ä)                                               from admin_panel import admin_router                                              dp.include_router(admin_router)          logger.info("‚úÖ Admin –ø–∞–Ω–µ–ª—ñ “õ–æ—Å—ã–ª–¥—ã")                                        except Exception as e:                       logger.error(f"‚ùå Admin –ø–∞–Ω–µ–ª—ñ–Ω “õ–æ—Å—É–¥–∞ “õ–∞—Ç–µ: {e}")                                                                     try:                                         # –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∂“Ø–π–µ—Å—ñ–Ω “õ–æ—Å—É (–∫–æ–º–∞–Ω–¥–∞–ª–∞—Ä)                                             from moderation_system import mod_router                                          dp.include_router(mod_router)            logger.info("‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∂“Ø–π–µ—Å—ñ “õ–æ—Å—ã–ª–¥—ã")                                    except Exception as e:                       logger.error(f"‚ùå –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∂“Ø–π–µ—Å—ñ–Ω “õ–æ—Å—É–¥–∞ “õ–∞—Ç–µ: {e}")                                                                 # –ù–µ–≥—ñ–∑–≥—ñ router (–∫–æ–º–∞–Ω–¥–∞–ª–∞—Ä + –º”ô—Ç—ñ–Ω —Ç–µ–∫—Å–µ—Ä—É)                                     dp.include_router(router)                logger.info("‚úÖ –ù–µ–≥—ñ–∑–≥—ñ router “õ–æ—Å—ã–ª–¥—ã")                                                                                   try:                                         # ”ò–∫—ñ–º—à—ñ–ª—ñ–∫ –∏–µ—Ä–∞—Ä—Ö–∏—è (–°–û“¢–´–ù–î–ê - —Ç—ã–π—ã–º —Å”©–∑–¥–µ—Ä —Ç–µ–∫—Å–µ—Ä—É)                             from admin_hierarchy import admin_hierarchy_router                                dp.include_router(admin_hierarchy_router)                                         logger.info("‚úÖ ”ò–∫—ñ–º—à—ñ–ª—ñ–∫ –∂“Ø–π–µ—Å—ñ “õ–æ—Å—ã–ª–¥—ã")                                    except Exception as e:                       logger.error(f"‚ùå ”ò–∫—ñ–º—à—ñ–ª—ñ–∫ –∂“Ø–π–µ—Å—ñ–Ω “õ–æ—Å—É–¥–∞ “õ–∞—Ç–µ: {e}")                                                                 logger.info("üöÄ –ë–æ—Ç —ñ—Å–∫–µ “õ–æ—Å—ã–ª—É–¥–∞...")                                                                                     # Polling –±–∞—Å—Ç–∞—É                         await dp.start_polling(bot)                                                                                            if __name__ == '__main__':                   asyncio.run(main())
